# Роль для обновления пакетов программ на серверах

## Роль выполняет следующие действия
Роль сделана для специализированного применения.
Роль предназначена для обновления определённых пакетов на определённых серверах.
Список имён серверов и пакетов для обновления находятся в файле defaults/main.yml.
Списки серверов и пакетов программ для этой роли предварительно подготавливаются.
Подготавливаются автоматически средствами службы информационной безопасности.
Задача в Jira: ["Обновление версий пакетов программ на linux-серверах списка ЦБ"](https://jira.tcsbank.ru/browse/IN-527).

Для Ubuntu серверов есть два варианта использования роли (остальных правильных OS уровня enterprise это не касается).
1. Вариант обновления пакетов программ из общего доступного репозитория Ubuntu.  
   Это обыкновенный общеиспользуемый способ.
2. Вариант обновления пакетов программ из специального предварительно подготовленного снимка репозитория Ubuntu.  
   Здесь используется метка-тег репозитория этой роли.  
   Этот способ для тех, кому очень-очень нужно иметь в точности одинаковые версии пакетов на серверах при обновлении сейчас и, например, через пару месяцев.  
   Одинаковость достигается тем, что в снимке репозитория Ubuntu на определённую дату попросту никогда ничего иного не появится, кроме того, что было в него скачано в момент его создания. То есть ни новых версий пакетов не будет, ни старые версии никто не удалит.

---

## Перед использованием
  Перед применением роли обеспечьте себя планом восстановления в случае если после обновления пакетов программ нарушится работа прикладного программного обеспечения на целевом сервере. 
  Например, для виртуальных машин VmWare - обеспечьте себя свежим снапшотом для восстановления.

---

## Пример использования роли


Выбирается нужный вариант использования роли.


### Вариант №1. Клонирование роли, для простого обновления из общедоступного репозитория Ubuntu.
```bash
[user@centos homedir]$ mkdir roles
[user@centos homedir]$ cd roles
[user@centos roles]$ git clone -c http.sslVerify=false https://vm-gitlab01.tcsbank.ru/infra-compute/update_packages/update_packages.git
Cloning into 'update_packages'...
remote: Enumerating objects: 485, done.
remote: Counting objects: 100% (485/485), done.
remote: Compressing objects: 100% (350/350), done.
remote: Total 485 (delta 198), reused 0 (delta 0)
Receiving objects: 100% (485/485), 204.05 KiB | 0 bytes/s, done.
Resolving deltas: 100% (198/198), done.
[user@centos roles]$ cd ..
[user@centos homedir]$
```


### Вариант №2. Клонирование репозитория роли с определённой меткой-тегом (например v202104xx), когда нужно обновление из снимка репозитория Ubuntu.
```bash
[user@centos homedir]$ mkdir roles
[user@centos homedir]$ cd roles
[user@centos roles]$ git clone --branch v202104xx -c http.sslVerify=false https://vm-gitlab01.tcsbank.ru/infra-compute/update_packages/update_packages.git
Cloning into 'update_packages'...
remote: Enumerating objects: 95, done.
remote: Counting objects: 100% (95/95), done.
remote: Compressing objects: 100% (68/68), done.
remote: Total 95 (delta 31), reused 0 (delta 0)
Unpacking objects: 100% (95/95), done.
Note: checking out '78126c8dcdd464594361f662ca06421de1fd0b7b'.

You are in 'detached HEAD' state. You can look around, make experimental
changes and commit them, and you can discard any commits you make in this
state without impacting any branches by performing another checkout.

If you want to create a new branch to retain commits you create, you may
do so (now or later) by using -b with the checkout command again. Example:

  git checkout -b new_branch_name

[user@centos roles]$ cd ..
[user@centos homedir]$
```


Далее последовательность действий одинакова для любого из выбранных вариантов.


### Создание файла-плейбука для запуска роли.
```bash
[user@centos homedir]$ vim update_packages.yml
[user@centos homedir]$ cat update_packages.yml
---
- hosts: all
  become: yes
  module_defaults:
    apt:
      force_apt_get: yes
  roles:
    - role: update_packages
...
[user@centos homedir]$
```
### Создание файла списка хостов к которым будет применена роль.
```bash
[user@centos homedir]$ vim list_of_hosts
[user@centos homedir]$ cat list_of_hosts
[all]
host1
host2

[user@centos homedir]$
```

### Запускается тестирование применения роли с опцией --check и контролируется результат.
```bash
[user@centos homedir]$ ansible-playbook update_packages.yml -i list_of_hosts --become --extra-vars "ansible_user=user1" --ask-pass --ask-become-pass --check
SSH password: 
BECOME password[defaults to SSH password]: 

PLAY [all] ***********************************************************************************************************************************************************************************

TASK [Gathering Facts] ***********************************************************************************************************************************************************************
ok: [host2]
ok: [host1]

TASK [update_packages : Execute task for Ubuntu servers] *************************************************************************************************************************************
skipping: [host1]
included: /mnt/share/temporary/homedir/roles/update_packages/tasks/ubuntu.yml for host2

TASK [update_packages : Copy file apt.conf.patch from template] ******************************************************************************************************************************
changed: [host2]

TASK [update_packages : Copy file sources.list.patch from template] **************************************************************************************************************************
changed: [host2]

TASK [update_packages : Clean apt cache] *****************************************************************************************************************************************************
ok: [host2]

TASK [update_packages : Update apt cache, but use apt.conf.patch] ****************************************************************************************************************************
skipping: [host2]

TASK [update_packages : Print info about host and packages to update] ************************************************************************************************************************
ok: [host2] => {
    "msg": [
        "host2: clamav clamav-docs"
    ]
}

TASK [update_packages : Update packages] *****************************************************************************************************************************************************
skipping: [host2]

TASK [update_packages : Remove unneeded files apt.conf.patch, sources.list.patch] ************************************************************************************************************
ok: [host2] => (item=apt.conf.patch)
ok: [host2] => (item=sources.list.patch)

PLAY RECAP ***********************************************************************************************************************************************************************************
host1                : ok=1    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   
host2                : ok=7    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   

[user@centos homedir]$
```

### Запускается применение роли без опции --check и контролируется результат.
```bash
[user@centos homedir]$ ansible-playbook update_packages.yml -i list_of_hosts --become --extra-vars "ansible_user=user1" --ask-pass --ask-become-pass
```

---

## Возможные трудности

### Проблемная Ubuntu.

Как обычно, в большинстве случаев трудности возникают с Ubuntu.

Проверьте достаточность свободного места в разделе /boot. Это если среди обновляемых пакетов присутствуют пакеты, обновляющие ядро. Например, пакеты в имени которых есть linux-images, initramfs, kernel и т.п.
Если место в /boot забито старыми ядрами (обычно наставишимися автоматическим обновлением), то для очистки 
хлама можно использовать команду:
```bash
root@ubuntu:~# apt-get --purge autoremove
```
При этом следует помнить, что для успешной загрузки ОС после манипуляций с ядрами, так же должны быть обновлены и конфигурационные файлы загрузчика grub. Это обновление делается автоматически. Но если есть сомнения - что-то удалили руками, прервали выполнение команды apt-get --purge autoremove, не хватило места для корректного выполнения команды. Тогда можно обновить принудительно. Например, такой командой.
```bash
root@ubuntu:~# update-grub
```

---

## Проверка работы роли

Для проверки можно попробовать сделать обновление меньшего количества пакетов, чем это первоначально рекомендовано для 
сервера. Или же выполнить обновление на тестовом хосте. Для этого в файлике defaults/main.yml найдите имя хоста, 
на котором следует выполнить обновления пакетов. Продублируйте эту строчку. Закомментируйте оригинальную. В копии 
строчки можно поменять имя хоста на тестовое и можно уменьшить количество обновляемых пакетов до пары-тройки 
"безобидных" - например, "vim vim-common screen" или что там подобное в строчке есть.

Естественно можно попробовать выполнить команду обновления вручную из терминала из командной строки и посмотреть - не возникнут-ли какие 
сложности и предупредительные сообщения.

Специально для Ubuntu в плейбук tasks/ubuntu.yml добавлено создание файла журнала вывода выполняющихся на сервере команд. Файл создаётся 
в каталоге /tmp. Имя файла состоит из текущей даты, времени, имени сервера и названия этой роли.  
Например: /tmp/20210409-2053.m1-server02p.update_packages.txt
Однако обратите внимание, что в файл записывается вывод выполнившихся команд. Если команда "зависнет", то сообщения о процессе выполнения команды в
файл не попадает.

---

## Заметки по использованию роли
1. Если вы планируете обновлять пакеты на единичном количестве серверов: 1-ом, 2-х, 3-х и т.п. Оцените - есть-ли 
вообще смысл использовать ansible-роль для единичных и редких случаев. Ни проще-ли будет в терминале в командной строке выполнить 
однострочную команду обновления списка пакетов и закрыть этот вопрос.  


2. Для владельцев Ubuntu в большинстве случаев не за чем обязательно обновляться со снимка репозитория Ubuntu, 
сделанного на определённую дату (на текущий момент снимок делается раз в месяц).

   В этой роле по умолчанию используется настройки делающие обновление пактов не из снимка репозитория Ubuntu, а из общедоступного репозитория Ubuntu.
Чтобы задействовать снимок репозитория Ubuntu - используйте метку-тег.
 
   Первоначально использование снимка репозитория Ubuntu было сделано для удовлетворения желания одного Максима, который не хотел обновлять пакеты на своих 
серверах без ansible-роли и снимков репозитория Ubuntu. Когда снимки появились и появилась ansible-роль - 
обновлению пакетов это не помогло, потому, что серверы Максима направились в кубернетес и докер-контейнеры.
 
   Если вам "до звезды" снимки репозиториев Ubuntu, то, конечно, очень даже следует обновлять пакеты программ с тех 
путей до общего репозитория Ubuntu, которые у вас уже есть и работают на ваших Ubuntu-серверах.
 
   Снимки репозитория Ubuntu делаются лишь для того, чтобы фиксировать содержимое репозитория на момент создания этого 
снимка.
 
   Это связано с "замечательной" особенностью авторов и владельцев оригинального репозитория Ubuntu удалять из него немного 
устаревшие версии пакетов. 
 
   То есть может так случится, что устанавливая определённый пакет сегодня на один сервер 
у вас будет версия этого пакета v.1, а уже завтра ставя этот же пакет на другой сервер вы сможете поставить только 
версию v.2 этого пакета, а предыдущая версия v.1 из оригинального репозитория бесследно исчезнет. В итоге на 
серверах, где желательна одинаковая конфигурация программного обеспечения, получится расхождение версий пакетов.
